{{- if .Values.testFramework.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "prometheus-node-exporter.fullname" . }}-test-host-mounts"
  labels:
    {{- include "prometheus-node-exporter.labels" . | nindent 4 }}
    app.kubernetes.io/name: {{ include "prometheus-node-exporter.name" . }}-test
  annotations:
    "helm.sh/hook-weight": "4"
    {{- with .Values.testFramework.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  hostNetwork: {{ .Values.hostNetwork }}
  hostPID: {{ .Values.hostPID }}
  hostIPC: {{ .Values.hostIPC }}
  containers:
  - name: test-host-mounts
    image: busybox
    command:
      - /bin/sh
      - -c
      - |
        set -ex
        echo "Testing host mount configurations..."

        # Test host network
        echo "Host Network: {{ .Values.hostNetwork }}"
        echo "Host PID: {{ .Values.hostPID }}"
        echo "Host IPC: {{ .Values.hostIPC }}"

        # Test if we can access host filesystems (if mounted)
        {{- if .Values.hostRootFsMount.enabled }}
        if [ -d /host/root/proc ]; then
          echo "✅ Host root filesystem is mounted at /host/root"
          # Test if we can read some host files
          if [ -r /host/root/proc/version ]; then
            echo "✅ Can read host /proc/version"
          else
            echo "⚠️  Cannot read host /proc/version"
          fi
        else
          echo "❌ Host root filesystem not mounted as expected"
          exit 1
        fi
        {{- end }}

        {{- if .Values.hostProcFsMount.mountPropagation }}
        if [ -d /host/proc ]; then
          echo "✅ Host proc filesystem is mounted at /host/proc"
        else
          echo "⚠️  Host proc filesystem not mounted"
        fi
        {{- end }}

        {{- if .Values.hostSysFsMount.mountPropagation }}
        if [ -d /host/sys ]; then
          echo "✅ Host sys filesystem is mounted at /host/sys"
        else
          echo "⚠️  Host sys filesystem not mounted"
        fi
        {{- end }}

        # Test network namespace
        if ip addr show > /dev/null 2>&1; then
          echo "✅ Can access network namespace"
        else
          echo "⚠️  Cannot access network namespace"
        fi

        echo "✅ All host mount tests passed!"
  restartPolicy: Never
{{- end }}