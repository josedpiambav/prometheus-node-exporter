{{- if .Values.testFramework.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "prometheus-node-exporter.fullname" . }}-test-node-metrics"
  labels:
    {{- include "prometheus-node-exporter.labels" . | nindent 4 }}
    app.kubernetes.io/name: {{ include "prometheus-node-exporter.name" . }}-test
  annotations:
    "helm.sh/hook-weight": "2"
    {{- with .Values.testFramework.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  containers:
  - name: test-node-metrics
    image: busybox
    command:
      - /bin/sh
      - -c
      - |
        set -ex
        echo "Testing specific node exporter metrics..."

        # Get metrics data
        METRICS=$(wget -q -O- -T 10 http://{{ include "prometheus-node-exporter.fullname" . }}:{{ .Values.service.port }}/metrics)

        # Check for essential node metrics
        ESSENTIAL_METRICS=(
          "node_cpu_seconds_total"
          "node_memory_MemTotal_bytes"
          "node_filesystem_size_bytes"
          "node_network_receive_bytes_total"
          "node_load1"
        )

        for metric in "${ESSENTIAL_METRICS[@]}"; do
          if echo "$METRICS" | grep -q "^${metric}"; then
            echo "‚úÖ Found metric: $metric"
          else
            echo "‚ùå Missing essential metric: $metric"
            exit 1
          fi
        done

        # Check if we're getting data from mounted host filesystems
        if echo "$METRICS" | grep -q "node_filesystem_"; then
          echo "‚úÖ Filesystem metrics are being collected"
        else
          echo "‚ö†Ô∏è  No filesystem metrics found"
        fi

        # Check CPU metrics
        if echo "$METRICS" | grep -q "node_cpu_"; then
          echo "‚úÖ CPU metrics are being collected"
        else
          echo "‚ùå No CPU metrics found"
          exit 1
        fi

        # Count total node_ metrics
        METRIC_COUNT=$(echo "$METRICS" | grep -c "^node_")
        echo "üìä Found $METRIC_COUNT node_ metrics"

        if [ "$METRIC_COUNT" -gt 20 ]; then
          echo "‚úÖ Sufficient number of node metrics being exposed"
        else
          echo "‚ö†Ô∏è  Low metric count, possible collector issue"
        fi

        echo "‚úÖ All node metrics tests passed!"
  restartPolicy: Never
{{- end }}