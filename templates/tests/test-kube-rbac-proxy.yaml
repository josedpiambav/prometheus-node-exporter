{{- if and .Values.testFramework.enabled .Values.kubeRBACProxy.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "prometheus-node-exporter.fullname" . }}-test-kube-rbac-proxy"
  labels:
    {{- include "prometheus-node-exporter.labels" . | nindent 4 }}
    app.kubernetes.io/name: {{ include "prometheus-node-exporter.name" . }}-test
  annotations:
    "helm.sh/hook-weight": "5"
    {{- with .Values.testFramework.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  containers:
  - name: test-kube-rbac-proxy
    image: busybox
    command:
      - /bin/sh
      - -c
      - |
        set -ex
        echo "Testing kubeRBACProxy configuration..."

        # Test proxy endpoints port
        if nc -z -w 5 {{ include "prometheus-node-exporter.fullname" . }} {{ .Values.kubeRBACProxy.proxyEndpointsPort }}; then
          echo "✅ kubeRBACProxy endpoints port is listening"
        else
          echo "❌ kubeRBACProxy endpoints port not accessible"
          exit 1
        fi

        # Test that metrics are still accessible through proxy
        if wget -q -O- -T 5 http://{{ include "prometheus-node-exporter.fullname" . }}:{{ .Values.service.port }}/metrics | head -5 | grep -q "node_"; then
          echo "✅ Metrics are accessible through kubeRBACProxy"
        else
          echo "❌ Cannot access metrics through kubeRBACProxy"
          exit 1
        fi

        # Test proxy health endpoint
        if wget -q -O- -T 5 http://{{ include "prometheus-node-exporter.fullname" . }}:{{ .Values.kubeRBACProxy.proxyEndpointsPort }}/healthz | grep -q "ok"; then
          echo "✅ kubeRBACProxy health endpoint is working"
        else
          echo "❌ kubeRBACProxy health endpoint not working"
          exit 1
        fi

        echo "✅ All kubeRBACProxy tests passed!"
  restartPolicy: Never
{{- end }}